var async=require("async"),fs=require("fs-extra"),imageSize=require("image-size"),jimp=require("jimp"),utilities=require("extra-utilities"),fileUtilities=require("file-utilities"),imageUtilities={getImageInformation:function(imageFilePath,callback){if(!utilities.isFunction(callback))throw new Error("Missing or invalid callback function!");return utilities.isEmptyString(imageFilePath)?callback(new Error("Missing or invalid image file path!")):async.waterfall([function(callback){return fileUtilities.getFileInformation(imageFilePath,function(error,info){return error?callback(error):callback(null,info)})},function(info,callback){return imageSize(imageFilePath,function(error,dimensions){return error?callback(error):callback(null,info,{width:dimensions.width,height:dimensions.height})})}],function(error,info,size){return error?callback(error):callback(null,utilities.merge(info,size))})},resizeImage:function(options,callback){var error,formattedOptions=null;try{formattedOptions=utilities.formatObject(options,{source:{type:"string",trim:!0,required:!0},destination:{type:"string",trim:!0,required:!0},width:{type:"number",subtype:"integer",required:!0,validator:function(value){return 0<value}},height:{type:"number",subtype:"integer",required:!0,validator:function(value){return 0<value}},overwrite:{type:"boolean",required:!1,default:!1},information:{type:"boolean",default:!0}},!0,!0)}catch(error){return error.status=400,callback(error)}return null===formattedOptions?((error=new Error("Missing or invalid image resizing options.")).status=400,callback(error)):fs.existsSync(formattedOptions.source)?fs.existsSync(formattedOptions.destination)&&!formattedOptions.overwrite?((error=new Error("Destination file already exists! Use truthful overwrite option or remove image and try again.")).status=400,callback(error)):async.waterfall([function(callback){var filePath=utilities.getFilePath(formattedOptions.destination);return utilities.isEmptyString(filePath)?callback():fs.existsSync(filePath)?callback():fs.mkdirp(filePath,function(error){return error?callback(error):callback()})},function(callback){return jimp.read(formattedOptions.source,function(error,image){return error?callback(error):image.scaleToFit(formattedOptions.width,formattedOptions.height).write(formattedOptions.destination,function(){return callback()})})},function(callback){return formattedOptions.information?imageUtilities.getImageInformation(formattedOptions.destination,function(error,information){return error?callback(error):(information.path=formattedOptions.destination,callback(null,information))}):callback(null,null)}],function(error,information){return error?callback(error):utilities.isValid(information)?callback(null,information):callback()}):((error=new Error("Image resizing failed, source file does not exist!")).status=400,callback(error))}};module.exports=imageUtilities;